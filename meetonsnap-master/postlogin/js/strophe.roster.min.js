Strophe.addConnectionPlugin("roster",{_connection:null,_callbacks:[],items:[],ver:null,init:function(t){this._connection=t,this.items=[];var e,n=this,i=t.connect,s=t.attach,r=function(i){if(i==Strophe.Status.ATTACHED||i==Strophe.Status.CONNECTED)try{t.addHandler(n._onReceivePresence.bind(n),null,"presence",null,null,null),t.addHandler(n._onReceiveIQ.bind(n),Strophe.NS.ROSTER,"iq","set",null,null)}catch(s){Strophe.error(s)}null!==e&&e.apply(this,arguments)};t.connect=function(n,s,o){e=o,"undefined"==typeof arguments[0]&&(arguments[0]=null),"undefined"==typeof arguments[1]&&(arguments[1]=null),arguments[2]=r,i.apply(t,arguments)},t.attach=function(n,i,o,u){e=u,"undefined"==typeof arguments[0]&&(arguments[0]=null),"undefined"==typeof arguments[1]&&(arguments[1]=null),"undefined"==typeof arguments[2]&&(arguments[2]=null),arguments[3]=r,s.apply(t,arguments)},Strophe.addNamespace("ROSTER_VER","urn:xmpp:features:rosterver")},supportVersioning:function(){return this._connection.features&&this._connection.features.getElementsByTagName("ver").length>0},get:function(t,e,n){var i={xmlns:Strophe.NS.ROSTER};this.items=[],this.supportVersioning()&&(i.ver=e||"",this.items=n||[]);var s=$iq({type:"get",id:this._connection.getUniqueId("roster")}).c("query",i);return this._connection.sendIQ(s,this._onReceiveRosterSuccess.bind(this,t),this._onReceiveRosterError.bind(this,t))},registerCallback:function(t){this._callbacks.push(t)},findItem:function(t){for(var e=0;e<this.items.length;e++)if(this.items[e]&&this.items[e].jid==t)return this.items[e];return!1},removeItem:function(t){for(var e=0;e<this.items.length;e++)if(this.items[e]&&this.items[e].jid==t)return this.items.splice(e,1),!0;return!1},subscribe:function(t,e){var n=$pres({to:t,type:"subscribe"});e&&""!=e&&n.c("status").t(e),this._connection.send(n)},unsubscribe:function(t,e){var n=$pres({to:t,type:"unsubscribe"});e&&""!=e&&n.c("status").t(e),this._connection.send(n)},authorize:function(t,e){var n=$pres({to:t,type:"subscribed"});e&&""!=e&&n.c("status").t(e),this._connection.send(n)},unauthorize:function(t,e){var n=$pres({to:t,type:"unsubscribed"});e&&""!=e&&n.c("status").t(e),this._connection.send(n)},add:function(t,e,n,i){for(var s=$iq({type:"set"}).c("query",{xmlns:Strophe.NS.ROSTER}).c("item",{jid:t,name:e}),r=0;r<n.length;r++)s.c("group").t(n[r]).up();this._connection.sendIQ(s,i,i)},update:function(t,e,n,i){var s=this.findItem(t);if(!s)throw"item not found";for(var r=e||s.name,o=n||s.groups,u=$iq({type:"set"}).c("query",{xmlns:Strophe.NS.ROSTER}).c("item",{jid:s.jid,name:r}),c=0;c<o.length;c++)u.c("group").t(o[c]).up();return this._connection.sendIQ(u,i,i)},remove:function(t,e){var n=this.findItem(t);if(!n)throw"item not found";var i=$iq({type:"set"}).c("query",{xmlns:Strophe.NS.ROSTER}).c("item",{jid:n.jid,subscription:"remove"});this._connection.sendIQ(i,e,e)},_onReceiveRosterSuccess:function(t,e){this._updateItems(e),t(this.items)},_onReceiveRosterError:function(t){t(this.items)},_onReceivePresence:function(t){var e=t.getAttribute("from"),n=Strophe.getBareJidFromJid(e),i=this.findItem(n);if(!i)return!0;var s=t.getAttribute("type");if("unavailable"==s)delete i.resources[Strophe.getResourceFromJid(e)];else{if(s)return!0;i.resources[Strophe.getResourceFromJid(e)]={show:0!=t.getElementsByTagName("show").length?Strophe.getText(t.getElementsByTagName("show")[0]):"",status:0!=t.getElementsByTagName("status").length?Strophe.getText(t.getElementsByTagName("status")[0]):"",priority:0!=t.getElementsByTagName("priority").length?Strophe.getText(t.getElementsByTagName("priority")[0]):""}}return this._call_backs(this.items,i),!0},_call_backs:function(t,e){for(var n=0;n<this._callbacks.length;n++)this._callbacks[n](t,e)},_onReceiveIQ:function(t){var e=t.getAttribute("id"),n=t.getAttribute("from");if(n&&""!=n&&n!=this._connection.jid&&n!=Strophe.getBareJidFromJid(this._connection.jid))return!0;var i=$iq({type:"result",id:e,from:this._connection.jid});return this._connection.send(i),this._updateItems(t),!0},_updateItems:function(t){var e=t.getElementsByTagName("query");if(0!=e.length){this.ver=e.item(0).getAttribute("ver");var n=this;Strophe.forEachChild(e.item(0),"item",function(t){n._updateItem(t)})}this._call_backs(this.items)},_updateItem:function(t){var e=t.getAttribute("jid"),n=t.getAttribute("name"),i=t.getAttribute("subscription"),s=t.getAttribute("ask"),r=[];if(Strophe.forEachChild(t,"group",function(t){r.push(Strophe.getText(t))}),"remove"==i)return void this.removeItem(e);var t=this.findItem(e);t?(t.name=n,t.subscription=i,t.ask=s,t.groups=r):this.items.push({name:n,jid:e,subscription:i,ask:s,groups:r,resources:{}})}});
